<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>LiteShare - Secure Serverless Sharing</title>
        <link
            href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap"
            rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <style>
            :root {
                --bg: #0f172a;
                --surface: #1e293b;
                --primary: #3b82f6;
                --text: #f8fafc;
                --text-dim: #94a3b8;
                --border: #334155;
                --danger: #ef4444;
                --success: #22c55e;
            }

            body {
                font-family: 'Inter', sans-serif;
                background: var(--bg);
                color: var(--text);
                margin: 0;
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .hidden {
                display: none !important;
            }

            /* Buttons */
            .btn {
                background: var(--primary);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                transition: 0.2s;
                font-size: 0.95rem;
            }

            .btn:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }

            .btn-outline {
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text);
            }

            .btn-outline:hover {
                background: var(--surface);
                border-color: var(--text-dim);
            }

            /* Inputs */
            input,
            select,
            textarea {
                background: var(--surface);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 10px;
                border-radius: 6px;
                font-family: inherit;
                outline: none;
                transition: border-color 0.2s;
            }

            input:focus,
            textarea:focus,
            select:focus {
                border-color: var(--primary);
            }

            /* Header */
            header {
                border-bottom: 1px solid var(--border);
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(15, 23, 42, 0.95);
                backdrop-filter: blur(10px);
            }

            .logo {
                font-weight: 700;
                font-size: 1.4rem;
                color: var(--primary);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .logo span {
                color: #fff;
            }

            .nav-controls {
                display: flex;
                gap: 15px;
                align-items: center;
            }

            .lang-select {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid var(--border);
                padding: 6px 10px;
                font-size: 0.85rem;
                cursor: pointer;
            }

            /* Main Layout */
            main {
                flex: 1;
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow-y: auto;
                padding: 20px;
            }

            .view-container {
                width: 100%;
                max-width: 800px;
                background: #162032;
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 30px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Components */
            .auth-box {
                text-align: center;
                max-width: 400px;
            }

            .auth-step {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-top: 25px;
            }

            .otp-input {
                text-align: center;
                letter-spacing: 8px;
                font-size: 1.5rem;
                font-weight: bold;
            }

            /* Create Header Updates */
            .create-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 15px;
                gap: 10px;
                flex-wrap: wrap;
                align-items: center;
            }

            .create-tools {
                display: flex;
                gap: 10px;
                flex: 1;
            }

            /* CODE EDITOR STYLES */
            .editor-wrapper {
                display: flex;
                position: relative;
                background: #0d1117;
                border: 1px solid var(--border);
                border-radius: 6px;
                overflow: hidden;
                height: 400px;
                /* Fixed height */
                margin-bottom: 15px;
            }

            .line-numbers {
                width: 45px;
                background: #161b22;
                color: #484f58;
                text-align: right;
                padding: 10px 5px;
                font-family: 'JetBrains Mono', monospace;
                font-size: 14px;
                line-height: 1.6;
                border-right: 1px solid var(--border);
                user-select: none;
                overflow: hidden;
                display: none;
                /* Hidden by default */
            }

            .editor-area {
                flex: 1;
                border: none;
                border-radius: 0;
                margin: 0;
                resize: none;
                padding: 10px;
                line-height: 1.6;
                font-size: 14px;
                white-space: pre-wrap;
                /* Default wrap */
                background: transparent;
                color: #e6edf3;
                overflow: auto;
            }

            /* Active Editor Mode */
            .editor-wrapper.code-mode .line-numbers {
                display: block;
            }

            .editor-wrapper.code-mode .editor-area {
                white-space: pre;
                /* No wrap in code mode */
                font-family: 'JetBrains Mono', monospace;
            }

            /* Viewer Specific */
            .viewer-content-area {
                width: 100%;
                height: 100%;
                overflow: auto;
                border: none;
                padding: 10px;
                background: transparent;
                color: #e6edf3;
                font-family: inherit;
                white-space: pre-wrap;
            }

            /* Result */
            .result-box {
                text-align: center;
            }

            .qr-wrapper {
                background: white;
                padding: 15px;
                border-radius: 12px;
                display: inline-block;
                margin: 25px 0;
            }

            .link-group {
                display: flex;
                gap: 0;
                background: #0d1117;
                padding: 0;
                border-radius: 8px;
                border: 1px solid var(--border);
                overflow: hidden;
                margin-top: 10px;
            }

            .link-group input {
                border: none;
                background: transparent;
                flex: 1;
                font-family: 'JetBrains Mono';
                font-size: 0.9em;
                padding: 12px;
            }

            .link-group button {
                border-radius: 0;
                margin: 0;
            }

            /* Dashboard */
            .table-responsive {
                overflow-x: auto;
                margin-top: 20px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9rem;
            }

            th,
            td {
                text-align: left;
                padding: 15px;
                border-bottom: 1px solid var(--border);
            }

            th {
                color: var(--text-dim);
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.75rem;
                letter-spacing: 0.05em;
            }

            tr:hover {
                background: rgba(255, 255, 255, 0.03);
            }

            .id-cell {
                font-family: 'JetBrains Mono';
                color: var(--primary);
                text-decoration: none;
            }

            .id-cell:hover {
                text-decoration: underline;
            }

            /* Viewer Header */
            .viewer-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--border);
            }

            .viewer-controls {
                display: flex;
                gap: 8px;
            }

            .viewer-meta {
                color: var(--text-dim);
                font-size: 0.85em;
                margin-bottom: 15px;
                display: flex;
                gap: 15px;
                align-items: center;
            }

            /* Loading */
            #loading {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(15, 23, 42, 0.8);
                backdrop-filter: blur(4px);
                z-index: 999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: white;
                font-weight: 600;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.1);
                border-top-color: var(--primary);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                margin-bottom: 15px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>

    <body>
        <div id="loading" class="hidden">
            <div class="spinner"></div> <span data-i18n="processing">Processing...</span>
        </div>

        <header>
            <div class="logo" onclick="app.goHome()">‚ö° <span>LiteShare</span></div>
            <div class="nav-controls">
                <select id="langSelect" class="lang-select" onchange="app.setLang(this.value)">
                    <option value="en">üá∫üá∏ EN</option>
                    <option value="vi">üáªüá≥ VN</option>
                </select>
                <div id="userNav"></div>
            </div>
        </header>

        <main>
            <!-- 1. AUTH -->
            <div id="view-auth" class="view-container auth-box hidden">
                <h2 data-i18n="loginTitle">Login / Register</h2>
                <p style="color: var(--text-dim)" data-i18n="loginSubtitle">Enter your email to receive a secure code
                </p>
                <div id="step-email" class="auth-step">
                    <input type="email" id="inputEmail" placeholder="name@example.com" autofocus>
                    <button class="btn" onclick="auth.sendOtp()" data-i18n="sendCodeBtn">Send Code</button>
                </div>
                <div id="step-otp" class="auth-step hidden">
                    <input type="text" id="inputOtp" class="otp-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6">
                    <button class="btn" onclick="auth.verifyOtp()" data-i18n="verifyBtn">Verify & Login</button>
                    <button class="btn-outline" onclick="auth.reset()" data-i18n="backBtn">Go Back</button>
                </div>
            </div>

            <!-- 2. DASHBOARD -->
            <div id="view-dashboard" class="view-container hidden">
                <div class="create-header">
                    <h3 style="margin:0" data-i18n="historyTitle">My Shared Links</h3>
                    <button class="btn" onclick="app.showCreate()" data-i18n="createNewBtn">+ Create New</button>
                </div>
                <div class="table-responsive">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th data-i18n="typeCol">Type</th>
                                <th data-i18n="createdCol">Created</th>
                                <th data-i18n="expiresCol">Expires</th>
                                <th data-i18n="viewsCol">Views</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. CREATE -->
            <div id="view-create" class="view-container hidden">
                <div class="create-header">
                    <div class="create-tools">
                        <select id="shareDuration" style="flex:1">
                            <option value="10" data-i18n="time10m">‚è± 10 Minutes</option>
                            <option value="60" data-i18n="time1h">‚è± 1 Hour</option>
                            <option value="1440" data-i18n="time1d">üìÖ 1 Day</option>
                            <option value="10080" data-i18n="time1w">üìÖ 1 Week</option>
                            <option value="43200" data-i18n="time1mo">üìÖ 1 Month</option>
                            <option value="525600" data-i18n="time1y">üìÖ 1 Year</option>
                            <option value="52560000" data-i18n="timeForever">‚àû Forever</option>
                        </select>
                        <button class="btn-outline" id="btnToggleEditorCreate" onclick="editor.toggleMode('create')"
                            style="white-space:nowrap" data-i18n="editorMode">{ } Editor Mode</button>
                    </div>
                </div>

                <!-- Editor Wrapper -->
                <div class="editor-wrapper" id="createEditorWrapper">
                    <div class="line-numbers" id="createLineNumbers">1</div>
                    <textarea id="textContent" class="editor-area" placeholder="Paste your text or code here..."
                        spellcheck="false"></textarea>
                </div>

                <button class="btn" style="width: 100%; padding: 15px;" onclick="sharing.upload()"
                    data-i18n="saveShareBtn">Save & Create Link</button>
            </div>

            <!-- 4. RESULT -->
            <div id="view-result" class="view-container result-box hidden">
                <h3 data-i18n="successTitle" style="color: var(--success)">üéâ Link Created Successfully!</h3>
                <div class="qr-wrapper">
                    <div id="qrcode"></div>
                </div>
                <div class="link-group">
                    <input type="text" id="shareLink" readonly onclick="this.select()">
                    <button class="btn" onclick="sharing.copyLink()" data-i18n="copyBtn">Copy Link</button>
                </div>
                <p style="color: var(--danger); font-size: 0.9em; margin-top: 25px;">
                    <span data-i18n="expiresLabel">This link expires at:</span> <br>
                    <b id="expireDisplay" style="font-family: 'JetBrains Mono'"></b>
                </p>
                <button class="btn-outline" style="margin-top: 15px;" onclick="app.goHome()" data-i18n="homeBtn">Back to
                    Home</button>
            </div>

            <!-- 5. VIEWER -->
            <div id="view-viewer" class="view-container hidden">
                <div class="viewer-header">
                    <h3 data-i18n="sharedContentTitle" style="margin:0">Shared Content</h3>
                    <div class="viewer-controls">
                        <button class="btn-outline" onclick="editor.toggleMode('view')" id="btnToggleEditorView"
                            style="font-size:0.8rem; padding: 5px 10px;">{ } Editor Mode</button>
                        <button class="btn hidden" id="btnEdit" onclick="viewer.enableEdit()" data-i18n="editBtn"
                            style="font-size:0.8rem; padding: 5px 10px;">Edit</button>
                    </div>
                </div>
                <div class="viewer-meta">
                    <span id="viewMetaDate"></span>
                    <span id="viewOwnerBadge"
                        style="color: var(--primary); border:1px solid var(--primary); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; display:none">Owner</span>
                </div>

                <!-- View Mode Editor Wrapper -->
                <div class="editor-wrapper" id="viewEditorWrapper">
                    <div class="line-numbers" id="viewLineNumbers">1</div>
                    <div id="viewContent" class="viewer-content-area"></div>
                </div>

                <!-- Edit Mode (Hidden textarea for editing existing shares) -->
                <div class="editor-wrapper hidden" id="editEditorWrapper">
                    <div class="line-numbers" id="editLineNumbers">1</div>
                    <textarea id="editContent" class="editor-area" spellcheck="false"></textarea>
                </div>

                <div id="editControls" class="hidden" style="margin-top:10px; text-align:right">
                    <button class="btn-outline" onclick="viewer.cancelEdit()" data-i18n="cancelBtn">Cancel</button>
                    <button class="btn" onclick="viewer.saveEdit()" data-i18n="saveBtn"
                        style="margin-left:5px">Save</button>
                </div>

                <button class="btn" style="margin-top: 25px; width: 100%" onclick="app.goHome()"
                    data-i18n="createOwnBtn">Create your own share</button>
            </div>
        </main>

        <script>
            // C·∫§U H√åNH: S·ª≠a PLACEHOLDER_API_URL th√†nh link th·∫≠t n·∫øu ch·∫°y local
            const API_URL = "PLACEHOLDER_API_URL";

            const TRANSLATIONS = {
                en: { loginBtn: "Login", logoutBtn: "Logout", loginTitle: "Login / Register", loginSubtitle: "Enter your email to receive a secure code", sendCodeBtn: "Send Code", verifyBtn: "Verify & Login", backBtn: "Go Back", historyTitle: "My Shared Links", createNewBtn: "+ Create New", typeCol: "Type", createdCol: "Created", expiresCol: "Expires", viewsCol: "Views", typeText: "üìù Text / Code", typeFile: "üìÅ File (Coming soon)", time10m: "‚è± 10 Minutes", time1h: "‚è± 1 Hour", time1d: "üìÖ 1 Day", time1w: "üìÖ 1 Week", time1mo: "üìÖ 1 Month", time1y: "üìÖ 1 Year", timeForever: "‚àû Forever", saveShareBtn: "Save & Create Link", successTitle: "üéâ Link Created Successfully!", copyBtn: "Copy Link", expiresLabel: "This link expires at:", homeBtn: "Back to Home", sharedContentTitle: "Shared Content", createOwnBtn: "Create your own share", processing: "Processing...", placeholderEditor: "Paste your text or code here...", placeholderEmail: "name@example.com", placeholderOtp: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", msgCopied: "Link copied!", msgNoContent: "Content cannot be empty!", msgError: "Connection Error", noData: "No history found.", createdLabel: "Created", editBtn: "Edit", cancelBtn: "Cancel", saveBtn: "Save", editorMode: "{ } Editor Mode", msgUpdateSuccess: "Updated successfully!", msgNotOwner: "Not authorized!" },
                vi: { loginBtn: "ƒêƒÉng nh·∫≠p", logoutBtn: "ƒêƒÉng xu·∫•t", loginTitle: "ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω", loginSubtitle: "Nh·∫≠p email ƒë·ªÉ nh·∫≠n m√£ b·∫£o m·∫≠t", sendCodeBtn: "G·ª≠i M√£", verifyBtn: "X√°c nh·∫≠n & V√†o", backBtn: "Quay l·∫°i", historyTitle: "Link ƒê√£ Chia S·∫ª", createNewBtn: "+ T·∫°o M·ªõi", typeCol: "Lo·∫°i", createdCol: "Ng√†y t·∫°o", expiresCol: "H·∫øt h·∫°n", viewsCol: "Xem", typeText: "üìù VƒÉn b·∫£n / Code", typeFile: "üìÅ T·ªáp tin (S·∫Øp ra m·∫Øt)", time10m: "‚è± 10 Ph√∫t", time1h: "‚è± 1 Gi·ªù", time1d: "üìÖ 1 Ng√†y", time1w: "üìÖ 1 Tu·∫ßn", time1mo: "üìÖ 1 Th√°ng", time1y: "üìÖ 1 NƒÉm", timeForever: "‚àû Vƒ©nh vi·ªÖn", saveShareBtn: "L∆∞u & T·∫°o Link", successTitle: "üéâ T·∫°o Link Th√†nh C√¥ng!", copyBtn: "Sao Ch√©p", expiresLabel: "Link s·∫Ω h·∫øt h·∫°n v√†o:", homeBtn: "V·ªÅ Trang Ch·ªß", sharedContentTitle: "N·ªôi Dung ƒê∆∞·ª£c Chia S·∫ª", createOwnBtn: "T·∫°o link chia s·∫ª c·ªßa b·∫°n", processing: "ƒêang x·ª≠ l√Ω...", placeholderEditor: "D√°n vƒÉn b·∫£n ho·∫∑c code v√†o ƒë√¢y...", placeholderEmail: "email@vidu.com", placeholderOtp: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", msgCopied: "ƒê√£ sao ch√©p link!", msgNoContent: "N·ªôi dung tr·ªëng!", msgError: "L·ªói k·∫øt n·ªëi", noData: "Ch∆∞a c√≥ d·ªØ li·ªáu.", createdLabel: "Ng√†y t·∫°o", editBtn: "S·ª≠a", cancelBtn: "H·ªßy", saveBtn: "L∆∞u", editorMode: "{ } Ch·∫ø ƒë·ªô Code", msgUpdateSuccess: "C·∫≠p nh·∫≠t th√†nh c√¥ng!", msgNotOwner: "B·∫°n kh√¥ng ph·∫£i ch·ªß s·ªü h·ªØu!" }
            };

            const state = { user: localStorage.getItem('ls_user'), lang: localStorage.getItem('ls_lang') || 'en', currentEmail: '', currentShareId: null, originalContent: '' };

            // --- EDITOR LOGIC ---
            const editor = {
                isCodeMode: { create: false, view: false, edit: false },

                init: () => {
                    editor.attachEvents('textContent', 'createLineNumbers', 'create');
                    editor.attachEvents('editContent', 'editLineNumbers', 'edit');
                    // View content needs special handling since it's a div
                    const viewContent = document.getElementById('viewContent');
                    viewContent.addEventListener('scroll', () => {
                        document.getElementById('viewLineNumbers').scrollTop = viewContent.scrollTop;
                    });
                },

                attachEvents: (textareaId, lineNumbersId, modeKey) => {
                    const textarea = document.getElementById(textareaId);
                    const lineNumbers = document.getElementById(lineNumbersId);

                    // Update lines on input
                    textarea.addEventListener('input', () => editor.updateLines(textarea, lineNumbers));
                    // Sync scroll
                    textarea.addEventListener('scroll', () => {
                        lineNumbers.scrollTop = textarea.scrollTop;
                    });
                    // Handle Tab key
                    textarea.addEventListener('keydown', (e) => {
                        if (e.key == 'Tab') {
                            e.preventDefault();
                            const start = textarea.selectionStart;
                            const end = textarea.selectionEnd;
                            textarea.value = textarea.value.substring(0, start) + "  " + textarea.value.substring(end);
                            textarea.selectionStart = textarea.selectionEnd = start + 2;
                            editor.updateLines(textarea, lineNumbers);
                        }
                    });
                },

                updateLines: (element, lineNumbersEle) => {
                    const val = element.value || element.innerText || "";
                    const lines = val.split('\n').length;
                    lineNumbersEle.innerHTML = Array(lines).fill(0).map((_, i) => `<div>${i + 1}</div>`).join('');
                },

                toggleMode: (context) => { // context: 'create' or 'view'
                    let wrapperId, btnId;
                    if (context === 'create') {
                        wrapperId = 'createEditorWrapper';
                        btnId = 'btnToggleEditorCreate';
                        // Trigger update lines immediately
                        editor.updateLines(document.getElementById('textContent'), document.getElementById('createLineNumbers'));
                    } else if (context === 'view') {
                        wrapperId = 'viewEditorWrapper'; // Default view wrapper
                        if (!document.getElementById('editEditorWrapper').classList.contains('hidden')) {
                            wrapperId = 'editEditorWrapper'; // If editing, toggle edit wrapper
                            editor.updateLines(document.getElementById('editContent'), document.getElementById('editLineNumbers'));
                        } else {
                            editor.updateLines(document.getElementById('viewContent'), document.getElementById('viewLineNumbers'));
                        }
                        btnId = 'btnToggleEditorView';
                    }

                    const wrapper = document.getElementById(wrapperId);
                    const btn = document.getElementById(btnId);

                    editor.isCodeMode[context] = !editor.isCodeMode[context];

                    if (editor.isCodeMode[context]) {
                        wrapper.classList.add('code-mode');
                        btn.style.background = 'var(--surface)';
                        btn.style.color = 'var(--primary)';
                        btn.style.borderColor = 'var(--primary)';
                    } else {
                        wrapper.classList.remove('code-mode');
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--text)';
                        btn.style.borderColor = 'var(--border)';
                    }
                }
            };

            const app = {
                init: () => {
                    document.getElementById('langSelect').value = state.lang;
                    app.applyLang();
                    editor.init(); // Init editor logic
                    const p = new URLSearchParams(window.location.search);
                    const id = p.get('id');
                    if (id) viewer.load(id);
                    else if (state.user) app.showDashboard();
                    else app.showCreate();
                    app.updateNav();
                },
                setLang: (l) => { state.lang = l; localStorage.setItem('ls_lang', l); app.applyLang(); },
                applyLang: () => {
                    const t = TRANSLATIONS[state.lang];
                    document.querySelectorAll('[data-i18n]').forEach(el => { const k = el.getAttribute('data-i18n'); if (t[k]) el.innerText = t[k]; });
                    document.getElementById('textContent').placeholder = t.placeholderEditor;
                    app.updateNav();
                },
                t: (k) => TRANSLATIONS[state.lang][k] || k,
                updateNav: () => {
                    const nav = document.getElementById('userNav');
                    if (state.user) nav.innerHTML = `<span style="font-size:0.9em;color:var(--text-dim);margin-right:8px;display:none;@media(min-width:600px){display:inline}">${state.user.split('@')[0]}</span> <button class="btn-outline" onclick="auth.logout()" style="padding:6px 12px;font-size:0.8rem">${app.t('logoutBtn')}</button>`;
                    else nav.innerHTML = `<button class="btn" onclick="app.showAuth()" style="padding:6px 15px;font-size:0.8rem">${app.t('loginBtn')}</button>`;
                },
                hideAll: () => document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden')),
                goHome: () => { try { window.history.pushState({}, document.title, window.location.pathname); } catch (e) { } state.user ? app.showDashboard() : app.showCreate(); },
                showAuth: () => { app.hideAll(); document.getElementById('view-auth').classList.remove('hidden'); document.getElementById('inputEmail').focus(); },
                showDashboard: () => { app.hideAll(); document.getElementById('view-dashboard').classList.remove('hidden'); dashboard.load(); },
                showCreate: () => {
                    app.hideAll();
                    document.getElementById('view-create').classList.remove('hidden');
                    document.getElementById('textContent').focus();
                    // Reset editor mode
                    const wrapper = document.getElementById('createEditorWrapper');
                    wrapper.classList.remove('code-mode');
                    editor.isCodeMode['create'] = false;
                    document.getElementById('btnToggleEditorCreate').style.cssText = "";
                },
                showResult: () => { app.hideAll(); document.getElementById('view-result').classList.remove('hidden'); },
                showViewer: () => { app.hideAll(); document.getElementById('view-viewer').classList.remove('hidden'); },
                toggleLoading: (show) => document.getElementById('loading').classList.toggle('hidden', !show)
            };

            const api = async (p) => {
                if (API_URL.includes("PLACEHOLDER")) { alert("L·ªói: Ch∆∞a c·∫•u h√¨nh API URL!"); return { success: false }; }
                app.toggleLoading(true); p.lang = state.lang;
                try { const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) }); const d = await r.json(); app.toggleLoading(false); return d; } catch (e) { app.toggleLoading(false); alert(app.t('msgError') + ": " + e); return { success: false }; }
            };

            const auth = {
                sendOtp: async () => { const e = document.getElementById('inputEmail').value; if (!e) return; state.currentEmail = e; const r = await api({ action: 'sendOtp', email: e }); if (r.success) { document.getElementById('step-email').classList.add('hidden'); document.getElementById('step-otp').classList.remove('hidden'); document.getElementById('inputOtp').focus(); } else alert(r.message); },
                verifyOtp: async () => { const o = document.getElementById('inputOtp').value; const r = await api({ action: 'verifyOtp', email: state.currentEmail, otp: o }); if (r.success) { state.user = r.token; localStorage.setItem('ls_user', state.user); app.updateNav(); app.showDashboard(); } else alert(r.message); },
                reset: () => { document.getElementById('step-email').classList.remove('hidden'); document.getElementById('step-otp').classList.add('hidden'); },
                logout: () => { localStorage.removeItem('ls_user'); state.user = null; app.updateNav(); app.showCreate(); }
            };

            const sharing = {
                upload: async () => { const c = document.getElementById('textContent').value; const d = document.getElementById('shareDuration').value; if (!c.trim()) return alert(app.t('msgNoContent')); const r = await api({ action: 'upload', type: 'text', content: c, duration: d, owner: state.user || 'guest' }); if (r.success) sharing.displayResult(r.id, r.expires); else alert(r.message); },
                displayResult: (id, exp) => { const u = window.location.href.split('?')[0] + '?id=' + id; document.getElementById('shareLink').value = u; document.getElementById('expireDisplay').innerText = new Date(exp).toLocaleString(state.lang); document.getElementById('qrcode').innerHTML = ""; new QRCode(document.getElementById("qrcode"), { text: u, width: 150, height: 150, correctLevel: QRCode.CorrectLevel.M }); app.showResult(); },
                copyLink: () => { const c = document.getElementById("shareLink"); c.select(); navigator.clipboard.writeText(c.value); alert(app.t('msgCopied')); }
            };

            const dashboard = {
                load: async () => { if (!state.user) return; const tb = document.querySelector('#historyTable tbody'); tb.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px">${app.t('processing')}</td></tr>`; const r = await api({ action: 'getHistory', email: state.user }); tb.innerHTML = ""; if (r.success && r.history.length > 0) { r.history.forEach(i => { const ex = new Date() > new Date(i.expires); const cl = ex ? 'var(--danger)' : 'var(--success)'; const tr = document.createElement('tr'); tr.innerHTML = `<td><a href="?id=${i.id}" target="_blank" class="id-cell">${i.id.substring(0, 8)}...</a></td><td>${i.type}</td><td>${new Date(i.created).toLocaleDateString(state.lang)}</td><td style="color:${cl}">${new Date(i.expires).toLocaleDateString(state.lang)}</td><td>${i.views}</td>`; tb.appendChild(tr); }); } else tb.innerHTML = `<tr><td colspan='5' style='text-align:center;color:var(--text-dim);padding:30px'>${app.t('noData')}</td></tr>`; }
            };

            const viewer = {
                load: async (id) => {
                    app.showViewer();
                    state.currentShareId = id;

                    // Reset View
                    const viewWrapper = document.getElementById('viewEditorWrapper');
                    viewWrapper.classList.remove('code-mode');
                    editor.isCodeMode['view'] = false;
                    document.getElementById('btnToggleEditorView').style.cssText = "";
                    document.getElementById('btnEdit').classList.add('hidden');
                    document.getElementById('viewContent').innerHTML = `<div style="text-align:center;padding:20px">${app.t('processing')}</div>`;

                    const r = await api({ action: 'getData', id: id });
                    if (r.success) {
                        state.originalContent = r.content;
                        document.getElementById('viewMetaDate').innerText = `${app.t('createdLabel')}: ${new Date(r.created).toLocaleString(state.lang)}`;
                        viewer.renderContent(r.content);
                        editor.updateLines(document.getElementById('viewContent'), document.getElementById('viewLineNumbers'));

                        if (state.user && state.user === r.owner) { document.getElementById('viewOwnerBadge').style.display = 'inline'; document.getElementById('btnEdit').classList.remove('hidden'); } else document.getElementById('viewOwnerBadge').style.display = 'none';
                    } else document.getElementById('viewContent').innerHTML = `<div style="color:var(--danger);text-align:center">‚õî ${r.message}</div>`;
                },
                renderContent: (t) => {
                    // Simple escape
                    const s = t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                    document.getElementById('viewContent').innerHTML = s;
                },
                enableEdit: () => {
                    document.getElementById('viewEditorWrapper').classList.add('hidden');
                    document.getElementById('editEditorWrapper').classList.remove('hidden');
                    document.getElementById('editControls').classList.remove('hidden');
                    document.getElementById('btnEdit').classList.add('hidden');

                    // Set content and trigger update
                    const editArea = document.getElementById('editContent');
                    editArea.value = state.originalContent;
                    editor.updateLines(editArea, document.getElementById('editLineNumbers'));

                    // Match mode
                    if (editor.isCodeMode['view']) {
                        document.getElementById('editEditorWrapper').classList.add('code-mode');
                    } else {
                        document.getElementById('editEditorWrapper').classList.remove('code-mode');
                    }

                    editArea.focus();
                },
                cancelEdit: () => {
                    document.getElementById('viewEditorWrapper').classList.remove('hidden');
                    document.getElementById('editEditorWrapper').classList.add('hidden');
                    document.getElementById('editControls').classList.add('hidden');
                    document.getElementById('btnEdit').classList.remove('hidden');
                },
                saveEdit: async () => {
                    const n = document.getElementById('editContent').value;
                    if (!n.trim()) return alert(app.t('msgNoContent'));
                    const r = await api({ action: 'update', id: state.currentShareId, email: state.user, content: n });
                    if (r.success) {
                        alert(app.t('msgUpdateSuccess'));
                        state.originalContent = n;
                        viewer.renderContent(n);
                        editor.updateLines(document.getElementById('viewContent'), document.getElementById('viewLineNumbers'));
                        viewer.cancelEdit();
                    } else alert(r.message);
                }
            };

            app.init();
        </script>
    </body>

</html>